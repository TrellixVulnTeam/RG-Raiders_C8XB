var r = require("wonka");

var e = require("@urql/core");

function _extends() {
  return (_extends = Object.assign || function(r) {
    for (var e = 1; e < arguments.length; e++) {
      var t = arguments[e];
      for (var a in t) {
        if (Object.prototype.hasOwnProperty.call(t, a)) {
          r[a] = t[a];
        }
      }
    }
    return r;
  }).apply(this, arguments);
}

exports.retryExchange = function retryExchange(t) {
  var a = t.initialDelayMs || 1e3;
  var n = t.maxDelayMs || 15e3;
  var o = t.maxNumberAttempts || 2;
  var i = t.randomDelay || !0;
  var u = t.retryIf || function(r) {
    return r && r.networkError;
  };
  return function(t) {
    var s = t.forward;
    var c = t.dispatchDebug;
    return function(t) {
      var y = r.share(t);
      var p = r.makeSubject();
      var v = p.source;
      var f = p.next;
      var d = r.mergeMap((function(t) {
        var u = t.key;
        var s = t.context;
        var p = (s.retryCount || 0) + 1;
        var v = s.retryDelay || a;
        var f = Math.random() + 1.5;
        if (i && v * f < n) {
          v *= f;
        }
        var d = r.filter((function(r) {
          return ("query" === r.kind || "teardown" === r.kind) && r.key === u;
        }))(y);
        "production" !== process.env.NODE_ENV && c({
          type: "retryAttempt",
          message: "The operation has failed and a retry has been triggered (" + p + " / " + o + ")",
          operation: t,
          data: {
            retryCount: p
          },
          source: "retryExchange"
        });
        return r.takeUntil(d)(r.delay(v)(r.fromValue(e.makeOperation(t.kind, t, _extends({}, t.context, {
          retryDelay: v,
          retryCount: p
        })))));
      }))(v);
      return r.filter((function(r) {
        if (!r.error || !u(r.error, r.operation)) {
          return !0;
        }
        if (!((r.operation.context.retryCount || 0) >= o - 1)) {
          f(r.operation);
          return !1;
        }
        "production" !== process.env.NODE_ENV && c({
          type: "retryExhausted",
          message: "Maximum number of retries has been reached. No further retries will be performed.",
          operation: r.operation,
          source: "retryExchange"
        });
        return !0;
      }))(r.share(s(r.merge([ y, d ]))));
    };
  };
};
//# sourceMappingURL=urql-exchange-retry.js.map
